# 자료 업로드 API 연결 (바이브 코딩)

## 바이브 코딩 이전 상태

- UI만 존재하는 상태

![image.png](<%EC%9E%90%EB%A3%8C%20%EC%97%85%EB%A1%9C%EB%93%9C%20API%20%EC%97%B0%EA%B2%B0%20(%EB%B0%94%EC%9D%B4%EB%B8%8C%20%EC%BD%94%EB%94%A9)/image.png>)

## 개발 목적

- 기존에 없던 점들을 추가하려 한다.
  1. 드래그 앤 드롭으로 파일을 추가하는 기능
  2. presigned url request body의 변경 (동일 파일명 오류 방지)을 위해 업로드 파일에 clientFileId를 추가
  3. presigned url API 연결
  4. presigned url을 통해 파일 업로드 중 로딩 스피너 추가
  5. API response에 따라 UI 렌더링 (업로드 실패 파일이 있다면 AI 라벨링 버튼 비활성화)

## 참고

- 코딩 규칙은 기존의 코딩 스타일로 하기

## 개발 단계

### 1. UI

- 파일 3개당 각각의 로딩 스피너 (이미 구현된 스피너 활용 애니메이션도 있음)

### 2. state와 event

- API 연동을 위해 추가되어야 할 state
  - 동일 파일명 구분을 위한 clientFileId
- API 연동을 위해 달아야 할 event
  - 드래그 앤 드롭으로 파일 추가 기능 필요

### 3. API 연결 (/upload/presignedurl)

- API 요청 함수(POST) 작성
  - API request
    ```c
    {
    	"clientFileId": 1,
    	"fileName": "resume_base.pdf",
    	"contentType": "application/pdf",
    	"fileSize": 1048576
    }
    ```
  - API response
    ```c
    {
    	"clientFileId" : 1,
    	"fileName": "resume_base.pdf",
    	"presignedUrl": "[https://softeer7-narratix-bucket.s3.ap-northeast-2.amazonaws.com/coverletter/user/a9b06e38-eb28-48569646e08](https://softeer7-narratix-bucket.s3.ap-northeast-2.amazonaws.com/coverletter/user/a9b06e38-eb28-48569646e08)....",
    	"fileKey": "coverletter/userid/a9b06e38-eb28-485f-8ce8-691e1ff14308.pdf",
    	"requiredHeaders": {
    		"Content-Type": "application/pdf",
    		"x-amz-meta-fileid" : "01KHQT95EAERKD0R1WJW1380MD"
    	}
    }
    ```
- Tanstack Query 적용

### 4. 응답 렌더링

- 응답의 loading과 error 처리
  - error는 현행대로 업로드 실패로 글자 표기
  - loading은 앞서 만들어진 로딩 스피너 활용

### 5. API 연결 완료시 동작

- 업로드 실패 파일이 하나라도 있다면 AI 라벨링 버튼 비활성화

# API 동작 설명

## 1) 파일 추가 시 즉시 업로드 (Presigned URL 단건 발급)

- 사용자가 파일을 **하나 추가할 때마다**
  - Client → Server: presigned-url 발급 요청 (1개)
  - Server → Client: presigned-url 응답
  - Client → S3: 해당 파일 즉시 업로드

### 업로드 결과 처리

- 성공: UI에 `업로드 완료`
- 진행 중: UI `업로드 중`
- 실패: UI에 `업로드 실패`
- 업로드 성공/실패 결과를 서버에 따로 알리지 않음

## 2) 버튼 상태 제어 (Client)

- 업로드 진행 상태를 기반으로 버튼 활성화

<조건>

- 업로드 실패 파일이 하나라도 있으면 → `[AI 라벨링 시작]` 버튼 비활성화
- 모든 파일이 업로드 성공이면 → 버튼 활성화

## 3) AI 라벨링 시작 요청 (Client → Server)

- 사용자가 `[AI 라벨링 시작]` 버튼 클릭
- Client → Server:
  - 업로드 성공한 파일들의 presignedUrl과 fileKey를 한 번에 전송
  ```json
  {
    "files": [
      {
        "presignedUrl": "[...]",
        "fileKey": "coverletter/userid/a9b06e38-eb28-485f-8ce8-691e1ff14308.pdf"
      }
    ]
  }
  ```

# 개발 계획 (상세)

## 1단계: 타입 정의 & API 함수 구성

### 1-1. 타입 정의 (upload.ts)

- ✅ `FileState`: 파일 상태 타입
  - `clientFileId: bigint` - 파일 고유 ID (BigInt 사용)
  - `file: File | null` - 파일 객체
  - `status: UploadStatus` - 업로드 상태
  - `presignedUrl?: string` - S3 presigned URL
  - `fileKey?: string` - S3 파일 경로
- ✅ `PresignedUrlRequest` - presigned URL 요청 타입
- ✅ `PresignedUrlResponse` - presigned URL 응답 타입
- ✅ `StartLabelingRequest` - AI 라벨링 시작 요청 타입

### 1-2. API 함수 (uploadApi.ts)

- ✅ `requestPresignedUrl()` - presigned URL 요청 함수
- ✅ `uploadFileToS3()` - S3에 파일 업로드하는 함수

**상태**: 완료 ✅

## 2단계: UploadFileArea 상태 관리 리팩토링 ✅

### 2-1. State 구조 변경

- ✅ 기존: `{ file, status }[]`
- ✅ 신규: `FileState[]` - clientFileId, presignedUrl, fileKey 포함

### 2-2. 파일 변경 핸들러

- ✅ 파일 선택/드래그 드롭 시 유효성 검사
- ✅ 유효성 검사 통과 시 자동으로 presigned URL 요청 & 업로드 시작 (순차적)
- ✅ 업로드 중 상태 관리

### 2-3. 순차 업로드 로직

- ✅ `uploadInProgressRef`로 현재 업로드 중인 파일 추적
- ✅ 중복 업로드 방지
- ✅ 각 파일별 독립적인 에러 처리

**상태**: 완료 ✅

## 3단계: AddFileItem 드래그 드롭 구현 ✅

### 3-1. Drag & Drop 이벤트

- ✅ `handleDragOver()` - 드래그 상태 시각화 (배경색/테두리 변경)
- ✅ `handleDragLeave()` - 드래그 종료
- ✅ `handleDrop()` - 파일 드롭 처리

### 3-2. 상태 변수

- ✅ `isDragOver` - 드래그 오버 상태 표시

### 3-3. UI 피드백

- ✅ 드래그 오버 시 배경 색상 변경 (blue-50), 테두리 표시

**상태**: 완료 ✅

## 4단계: 파일 삭제 (재시도 불가) ✅

### 4-1. 삭제 정책

- ✅ 업로드 실패 파일도 X 버튼으로만 삭제 가능
- ✅ 삭제 후 상태 초기화: `{ clientFileId, file: null, status: 'idle' }`
- ✅ 재시도는 파일 재선택으로만 가능

### 4-2. 삭제 구현

- ✅ `handleRemove()` - 파일 삭제 시 onFileChange(null) 호출

**상태**: 완료 ✅

## 5단계: AI 라벨링 버튼 활성화 조건 (예정)

## 5단계: AI 라벨링 버튼 활성화 조건 (예정)

### 5-1. 버튼 활성화 로직

- 업로드 실패 파일이 하나라도 있으면 비활성화
- 모든 파일이 success 상태일 필요는 없음 (최소 1개 이상 success면 활성화)

### 5-2. 구현 위치

- UploadInputSection 또는 상위 컴포넌트에서 관리
- `files` 배열을 통해 상태 확인

**상태**: 예정 ⏳

## 6단계: 테스트 포인트 (예정)

### 6-1. 파일 업로드 플로우

- [ ] 파일 선택 → presigned URL 요청 → S3 업로드
- [ ] 업로드 중 로딩 스피너 표시
- [ ] 업로드 성공/실패 상태 표시

### 6-2. 드래그 드롭

- [ ] 파일을 드래그하면 배경 변색
- [ ] 드래그 종료 시 원래 상태로 복구
- [ ] 드롭 시 파일 업로드 시작

### 6-3. 에러 처리

- [ ] 파일 크기 초과 → error 상태
- [ ] 파일 형식 불일치 → error 상태
- [ ] presigned URL 요청 실패 → error 상태
- [ ] S3 업로드 실패 → error 상태

### 6-4. 버튼 활성화

- [ ] 모든 파일 실패 → 버튼 비활성화
- [ ] 일부 파일 실패 → 버튼 비활성화
- [ ] 모든 파일 성공 → 버튼 활성화

**상태**: 예정 ⏳

- [ ] 파일 크기 초과 → error 상태
- [ ] 파일 형식 불일치 → error 상태
- [ ] presigned URL 요청 실패 → error 상태
- [ ] S3 업로드 실패 → error 상태

### 6-4. 버튼 활성화

- [ ] 모든 파일 실패 → 버튼 비활성화
- [ ] 일부 파일 실패 → 버튼 비활성화
- [ ] 모든 파일 성공 → 버튼 활성화
