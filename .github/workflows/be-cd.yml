name: be-cd.yml

on:
  push:
    branches: [ "be" ]
    paths:
      - 'backend/**'
      - '.github/workflows/be-cd.yml'

env:
  SPRING_PROFILES_ACTIVE: prod
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_HUB_HOST }}/${{ secrets.DOCKER_HUB_APP_NAME}}

jobs:
  build:
    name: CD Pipeline
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '17'
          cache: 'gradle'

      - name: touch yml files
        run: |
          touch ./src/main/resources/application.yml
          touch ./src/test/resources/application.yml

        shell: bash

      - name: copy application.yml files
        run: |
          echo "${{ secrets.APPLICATION_PROD_YML }}" > ./src/main/resources/application.yml
          echo "${{ secrets.APPLICATION_TEST_YML }}" > ./src/test/resources/application.yml

      - name: login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: üêòGradle Build
        run: |
          chmod +x ./gradlew
          ./gradlew clean build

      - name: üê≥Docker Image Build & Push
        run: |
          docker build \
          --build-arg SPRING_PROFILES_ACTIVE=$SPRING_PROFILES_ACTIVE \
          -t ${{ env.DOCKER_IMAGE_NAME }}:latest .
          docker push ${{ env.DOCKER_IMAGE_NAME }}:latest 

      - name: Send docker-compose.yml to EC2 Instance
        uses: appleboy/scp-action@master
        with:
          username: ubuntu
          host: ${{ secrets.SERVER_IP }}
          key: ${{ secrets.PEM_KEY }}
          source: "./backend/docker-compose.yml"
          target: "/home/ubuntu/app/backend/"
          strip_components: 1

      - name: Send deploy script to EC2 Instance
        uses: appleboy/scp-action@master
        with:
          username: ubuntu
          host: ${{ secrets.SERVER_IP }}
          key: ${{ secrets.PEM_KEY }}
          source: "./backend/script"
          target: "/home/ubuntu/app/backend/"
          strip_components: 1

      - name: Docker Container Run
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.SERVER_IP }}
          key: ${{ secrets.PEM_KEY }}
          script: |
            cd ~
            sudo chmod +x ./app/backend/script/*.sh
            ./app/backend/script/deploy.sh
            sudo docker image prune -f
            
            
